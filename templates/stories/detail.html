{% extends "base.html" %}
{% load static %}

{% block title %}{{ story.title }} - TravelScout{% endblock title %}

{% block content %}
<!-- Alpine.js (Collapse plagini kerak animatsiya uchun) -->
<script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

<div class="min-h-screen bg-gradient-to-br from-orange-50 via-amber-50 to-rose-50 font-sans py-12 px-4"
     x-data="{
        isLiked: {{ is_liked|yesno:'true,false' }},
        isSaved: {{ is_saved|yesno:'true,false' }},
        showComments: false,  // Comments boshida yopiq
        copied: false,
        newCommentText: '',

        async toggleLike() {
            try {
                const res = await fetch('{% url "toggle_like" story.id %}', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                });
                if (res.ok) this.isLiked = !this.isLiked;
            } catch (e) { console.error(e); }
        },

        async toggleSave() {
            try {
                const res = await fetch('{% url "toggle_save" story.id %}', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                });
                if (res.ok) this.isSaved = !this.isSaved;
            } catch (e) { console.error(e); }
        },

        async addComment() {
            if (!this.newCommentText.trim()) return;
            try {
                const res = await fetch('/stories/api/comment/{{ story.id }}/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ text: this.newCommentText })
                });
                if (res.ok) window.location.reload();
            } catch (e) { console.error(e); }
        },

        shareStory() {
            const url = window.location.origin + '/stories/' + '{{ story.share_uuid }}' + '/';
            navigator.clipboard.writeText(url);
            this.copied = true;
            setTimeout(() => this.copied = false, 2000);
        }
     }">

    <div class="max-w-4xl mx-auto">

        <!-- Back Button -->
        <a href="{% url 'stories_feed' %}" class="inline-flex items-center gap-2 text-gray-600 hover:text-orange-600 font-bold mb-8 transition-colors group">
            <div class="p-2 bg-white rounded-full shadow-sm group-hover:shadow-md transition-all">
                <svg class="w-4 h-4 transform group-hover:-translate-x-1 transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </div>
            Back to Stories
        </a>

        <!-- Main Card -->
        <div class="bg-white/80 backdrop-blur-xl shadow-xl rounded-[32px] border border-white/60 overflow-hidden mb-10">

            <!-- Author Header -->
            <div class="bg-gradient-to-r from-gray-50/50 to-white/50 p-6 border-b border-gray-100/50 flex items-center gap-4">
                <div class="w-14 h-14 rounded-full overflow-hidden border-2 border-white shadow-sm flex-shrink-0">
                    {% if story.author.profile.profile_picture %}
                        <img src="{{ story.author.profile.profile_picture.url }}" class="w-full h-full object-cover">
                    {% else %}
                        <div class="w-full h-full flex items-center justify-center bg-orange-100 text-orange-600 font-black text-xl">
                            {{ story.author.username|slice:":1"|upper }}
                        </div>
                    {% endif %}
                </div>
                <div>
                    <h1 class="text-xl md:text-2xl font-black text-gray-900 leading-tight">{{ story.title }}</h1>
                    <div class="flex flex-wrap items-center gap-2 text-xs md:text-sm text-gray-500 font-medium mt-1">
                        <span class="text-orange-600">@{{ story.author.username }}</span>
                        <span>•</span>
                        <span>{{ story.location }}</span>
                        <span>•</span>
                        <span>{{ story.created_at|date:"M d, Y" }}</span>
                    </div>
                </div>
            </div>

            <div class="p-6 md:p-8">
                <!-- Images -->
                {% if images %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-8">
                    {% for image in images %}
                        <div class="relative group overflow-hidden rounded-2xl shadow-sm aspect-[4/3]">
                            <img src="{{ image.image.url }}" class="w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-700">
                        </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Text -->
                <div class="prose prose-gray max-w-none text-gray-700 leading-relaxed mb-8">
                    {{ story.content|linebreaks }}
                </div>

                <!-- 4 COMPACT BUTTONS (Kichraytirilgan va Chiroyli) -->
                <div class="flex flex-wrap items-center justify-center sm:justify-start gap-3 pt-6 border-t border-gray-100">

                    <!-- Like -->
                    <button @click="toggleLike()"
                            class="flex items-center gap-2 px-5 py-2.5 rounded-full text-sm font-bold transition-all duration-200 transform hover:scale-105 active:scale-95 shadow-sm border border-transparent"
                            :class="isLiked ? 'bg-rose-100 text-rose-600 border-rose-200' : 'bg-gray-100 text-gray-600 hover:bg-rose-50 hover:text-rose-600'">
                        <svg class="w-5 h-5" :class="isLiked ? 'fill-current' : ''" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                        <span x-text="isLiked ? 'Liked' : 'Like'"></span>
                    </button>

                    <!-- Comment (Toggles visibility) -->
                    <button @click="showComments = !showComments"
                            class="flex items-center gap-2 px-5 py-2.5 rounded-full text-sm font-bold bg-blue-50 text-blue-600 hover:bg-blue-100 transition-all duration-200 transform hover:scale-105 active:scale-95 shadow-sm">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                        <span>{{ comments.count }} Comments</span>
                    </button>

                    <!-- Save -->
                    <button @click="toggleSave()"
                            class="flex items-center gap-2 px-5 py-2.5 rounded-full text-sm font-bold transition-all duration-200 transform hover:scale-105 active:scale-95 shadow-sm border border-transparent"
                            :class="isSaved ? 'bg-orange-100 text-orange-600 border-orange-200' : 'bg-gray-100 text-gray-600 hover:bg-orange-50 hover:text-orange-600'">
                        <svg class="w-5 h-5" :class="isSaved ? 'fill-current' : ''" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>
                        <span x-text="isSaved ? 'Saved' : 'Save'"></span>
                    </button>

                    <!-- Share -->
                    <button @click="shareStory()"
                            class="sm:ml-auto flex items-center gap-2 px-5 py-2.5 rounded-full text-sm font-bold bg-gray-800 text-white hover:bg-gray-700 transition-all duration-200 transform hover:scale-105 active:scale-95 shadow-md">
                        <template x-if="!copied">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"></line><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"></line></svg>
                        </template>
                        <template x-if="copied">
                            <svg class="w-4 h-4 text-green-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        </template>
                        <span x-text="copied ? 'Copied!' : 'Share'"></span>
                    </button>
                </div>

            </div>
        </div>

        <!-- COMMENTS SECTION (Expandable) -->
        <div x-show="showComments" x-collapse class="mt-6 bg-white/60 backdrop-blur-md rounded-[32px] border border-white/50 p-6 md:p-8 shadow-lg">
             <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-2">
                 Discussion <span class="bg-blue-100 text-blue-600 text-xs px-2 py-1 rounded-full">{{ comments.count }}</span>
             </h3>

             <!-- Input -->
             <div class="flex gap-3 mb-8">
                <div class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden flex-shrink-0 border-2 border-white shadow-sm">
                    {% if user.profile.profile_picture %}
                        <img src="{{ user.profile.profile_picture.url }}" class="w-full h-full object-cover">
                    {% else %}
                         <div class="w-full h-full flex items-center justify-center bg-gray-100 text-gray-400 font-bold">{{ user.username|slice:":1"|upper }}</div>
                    {% endif %}
                </div>
                <div class="flex-1 relative">
                    <input type="text" x-model="newCommentText" @keydown.enter="addComment()"
                           placeholder="Add to the discussion..."
                           class="w-full px-5 py-3 bg-white rounded-xl border border-gray-200 shadow-sm focus:ring-2 focus:ring-blue-200 focus:border-blue-400 outline-none transition-all pr-12 text-sm">

                    <button @click="addComment()" class="absolute right-2 top-1.5 p-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-sm">
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </div>
             </div>

             <!-- Comments List -->
             <div class="space-y-6">
                {% for comment in comments %}
                <div class="flex gap-3">
                    <div class="w-9 h-9 rounded-full bg-gray-200 overflow-hidden flex-shrink-0 mt-1">
                        {% if comment.author.profile.profile_picture %}
                            <img src="{{ comment.author.profile.profile_picture.url }}" class="w-full h-full object-cover">
                        {% else %}
                             <div class="w-full h-full flex items-center justify-center bg-gray-100 text-gray-500 font-bold text-xs">{{ comment.author.username|slice:":1"|upper }}</div>
                        {% endif %}
                    </div>
                    <div class="flex-1">
                        <div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-gray-100">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-bold text-gray-900 text-sm">{{ comment.author.username }}</span>
                                <span class="text-[10px] text-gray-400 font-medium uppercase tracking-wide">{{ comment.created_at|timesince }} ago</span>
                            </div>
                            <p class="text-gray-700 text-sm leading-relaxed">{{ comment.text }}</p>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-6 text-gray-400 text-sm">
                    No comments yet. Start the conversation!
                </div>
                {% endfor %}
             </div>
        </div>

    </div>
</div>
{% endblock content %}