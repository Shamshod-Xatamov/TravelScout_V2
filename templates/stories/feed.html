{% extends "base.html" %}
{% load static %}

{% block title %}Travel Stories - TravelScout{% endblock title %}

{% block content %}
<style>
    [x-cloak] {
        display: none !important;
    }
</style>
<!-- Alpine.js -->
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

<!-- Asosiy Alpine.js Logika -->
<div class="min-h-screen bg-gradient-to-br from-orange-50 via-amber-50 to-rose-50 font-sans pb-20"
     x-data="storiesApp()"


     x-init="initApp()"
// Keshdan kelgan bo'lsa ham, darhol success holatini o'chirish.
             this.submitSuccess = false;

             // Agar brauzerda back/forward bosilgan bo'lsa, uni majburiy FALSE qilish uchun.
             window.history.replaceState(null, null, window.location.pathname);>

    <div class="max-w-6xl mx-auto px-6 py-12">

        <!-- HEADER & FILTER -->
        <div class="mb-12">
            <div class="flex flex-col md:flex-row items-center justify-between gap-6 mb-8">
                <div>
                    <h1 class="text-4xl font-black text-gray-900 mb-2">Travel Stories</h1>
                    <p class="text-gray-600 text-lg">Share your adventures and inspire fellow travelers</p>
                </div>
                <!-- Share Your Story Button -->
                <button @click="openCreateStoryModal()"
                        class="flex items-center gap-2 bg-gradient-to-r from-orange-500 to-rose-500 text-white px-6 py-3 rounded-full hover:shadow-lg hover:scale-105 transition-all font-bold">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Share Your Story
                </button>
            </div>

            <!-- Filter Tabs -->
            <div class="flex items-center gap-3 overflow-x-auto pb-2">
                <button @click="activeFilter = 'all'"
                        :class="activeFilter === 'all' ? 'bg-gradient-to-r from-orange-500 to-rose-500 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-50'"
                        class="px-6 py-3 rounded-full font-bold transition-all whitespace-nowrap">
                    All Stories
                </button>
                <button @click="activeFilter = 'saved'"
                        :class="activeFilter === 'saved' ? 'bg-gradient-to-r from-orange-500 to-rose-500 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-50'"
                        class="flex items-center gap-2 px-6 py-3 rounded-full font-bold transition-all whitespace-nowrap">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>
                    Saved Stories
                </button>
                <button @click="activeFilter = 'my'"
                        :class="activeFilter === 'my' ? 'bg-gradient-to-r from-orange-500 to-rose-500 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-50'"
                        class="flex items-center gap-2 px-6 py-3 rounded-full font-bold transition-all whitespace-nowrap">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    My Stories
                </button>
            </div>
        </div>

       <!-- EMPTY STATE -->
<!-- EMPTY STATE -->
<template x-if="filteredStories.length === 0">
    <div class="bg-white rounded-3xl p-16 text-center shadow-lg">

        <!-- ICON QISMI -->
        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">

            <!-- SAVED STORIES IKONKASI (Icon va Matn bir xil joyda) -->
            <template x-if="activeFilter === 'saved'">
                <svg class="w-10 h-10 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                </svg>
            </template>

            <!-- MY STORIES IKONKASI -->
            <template x-if="activeFilter === 'my'">
                <svg class="w-10 h-10 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
            </template>

            <!-- ALL STORIES IKONKASI -->
            <template x-if="activeFilter === 'all'">
                <svg class="w-10 h-10 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                </svg>
            </template>

        </div>

        <!-- MATN QISMI (Bu yer o'chirilmagan) -->
        <h3 class="text-gray-900 mb-2 font-bold text-xl"
            x-text="activeFilter === 'saved' ? 'No Saved Stories Yet' : activeFilter === 'my' ? 'No Stories Published Yet' : 'No Stories Found'">
        </h3>

        <p class="text-gray-600 mb-6"
           x-text="activeFilter === 'saved' ? 'Stories you save will appear here for easy access.' : activeFilter === 'my' ? 'Share your first travel adventure with the community!' : 'Be the first to share a travel story!'">
        </p>

        <!-- TUGMA QISMI -->
        <template x-if="activeFilter === 'my'">
          <button @click="openCreateStoryModal()" class="inline-flex items-center gap-2 bg-gradient-to-r from-orange-500 to-rose-500 text-white px-6 py-3 rounded-full hover:from-orange-600 hover:to-rose-600 transition-all shadow-lg font-bold">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            Share Your First Story
          </button>
        </template>
    </div>
</template>

        <!-- STORIES FEED -->
        <div class="space-y-8">
            <template x-for="story in filteredStories" :key="story.id">
                <div class="bg-white rounded-3xl shadow-lg border border-gray-100 overflow-hidden hover:shadow-xl transition-shadow">

                    <!-- Story Header -->
                    <div class="p-6 border-b border-gray-50">
                        <div class="flex items-start justify-between">
                            <div class="flex items-center gap-4">
                                <!-- Avatar -->
                                <div class="w-12 h-12 rounded-full bg-gray-200 overflow-hidden">
                                    <template x-if="story.authorAvatar"><img :src="story.authorAvatar" class="w-full h-full object-cover"></template>
                                    <template x-if="!story.authorAvatar"><div class="w-full h-full flex items-center justify-center bg-orange-100 text-orange-600 font-bold" x-text="story.author[0].toUpperCase()"></div></template>
                                </div>
                                <div>
                                    <div class="text-gray-900 font-bold text-lg" x-text="story.author"></div>
                                    <div class="flex items-center gap-4 text-sm text-gray-500 mt-0.5">
                                        <div class="flex items-center gap-1"><svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg><span x-text="story.location"></span></div>
                                        <div class="flex items-center gap-1"><svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg><span x-text="story.date"></span></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Three-dot menu (only for owner) -->
                            <template x-if="story.authorId == currentUserId">
                                <div class="relative" x-data="{ open: false }">
                                    <button @click="open = !open" @click.outside="open = false" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
                                        <svg class="w-5 h-5 text-gray-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
                                    </button>

                                    <div x-show="open" x-cloak class="absolute right-0 top-10 bg-white rounded-2xl shadow-xl border border-gray-200 py-2 z-20 min-w-[160px]"
                                         x-transition:enter="transition ease-out duration-100" x-transition:enter-start="opacity-0 scale-90" x-transition:enter-end="opacity-100 scale-100">
                                        <button @click="openEditStoryModal(story); open=false" class="w-full px-4 py-3 flex items-center gap-3 hover:bg-gray-50 transition-colors text-left text-blue-600">
                                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                            <span class="text-gray-700">Edit Story</span>
                                        </button>
                                        <button @click="openDeleteStoryModal(story.id); open=false" class="w-full px-4 py-3 flex items-center gap-3 hover:bg-gray-50 transition-colors text-left text-red-600">
                                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                            <span class="text-gray-700">Delete Story</span>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Story Content -->
                    <div class="p-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-3" x-text="story.title"></h2>

                        <!-- Story text with Read More -->
                        <div class="mb-6">
    <p class="text-gray-700 leading-relaxed">
        <span x-text="story.content.substring(0, 250)"></span>
        <!-- Agar matn uzun bo'lsa, ... qo'shamiz -->
        <template x-if="story.content.length > 250">
            <span>...</span>
        </template>
    </p>

    <!-- Read More tugmasi (Hozirgi storyni detail sahifada ochadi) -->
    <template x-if="story.content.length > 250">
        <a :href="'/stories/' + story.share_uuid + '/'"
           class="text-orange-600 hover:text-orange-700 mt-2 transition-colors font-bold inline-block">
            Read More
        </a>
    </template>
</div>

                        <!-- Story Images -->
                        <!-- Story Images (IXCHAMLASHTIRILGAN) -->
<template x-if="story.images.length > 0">
    <div class="grid gap-2 mb-6"
         :class="story.images.length === 1 ? 'grid-cols-1' : 'grid-cols-2'">

        <template x-for="(image, index) in story.images">
            <!--
                O'ZGARGAM JOYI SHU YERDA:
                1. 'aspect-video' ni OLIB TASHLADIM.
                2. O'rniga 'h-64 md:h-80' qo'shdim.
                   Bu degani: Telefonda balandligi 256px, Kompyuterda 320px bo'ladi.
                   Rasm undan katta bo'lib ketmaydi.
            -->
            <div class="relative overflow-hidden rounded-2xl bg-gray-100 cursor-pointer w-full"
                 :class="story.images.length === 1 ? 'h-64 md:h-80' : 'aspect-square h-auto'"
                 @click="window.open(image, '_blank')">

                <!-- object-cover: Rasm cho'zilmasdan, qirqib joylashadi -->
                <img :src="image"
                     class="w-full h-full object-cover hover:scale-105 transition-transform duration-700"
                     alt="Story image">
            </div>
        </template>
    </div>
</template>

                        <!-- Story Stats -->
                        <div class="flex items-center gap-6 text-sm text-gray-600 mb-4">
                            <div class="flex items-center gap-1"><svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span x-text="story.likes + ' likes'"></span></div>
                            <div class="flex items-center gap-1"><svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z"></path><circle cx="12" cy="12" r="3"></circle></svg><span x-text="story.views + ' views'"></span></div>
                            <div class="flex items-center gap-1"><svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg><span x-text="story.comments.length + ' comments'"></span></div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex items-center gap-2 pb-6 border-b border-gray-100">
                            <!-- Like -->
                            <button @click="toggleLike(story.id)"
                                    class="flex items-center gap-1.5 px-4 py-2 rounded-full text-sm transition-all duration-300 transform hover:scale-105"
                                    :class="story.isLiked ? 'bg-rose-50 text-rose-600' : 'bg-gray-50 text-gray-700 hover:bg-rose-50 hover:text-rose-600'">
                                <svg class="w-4 h-4" :class="story.isLiked ? 'fill-rose-600' : ''" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                                <span x-text="story.isLiked ? 'Liked' : 'Like'"></span>
                            </button>

                            <!-- Comment -->
                            <button @click="openComments(story.id)" class="flex items-center gap-1.5 px-4 py-2 rounded-full text-sm bg-gray-50 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-all duration-300 transform hover:scale-105">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                                Comment
                            </button>

                            <!-- Save -->
                            <button @click="toggleSave(story.id)"
                                    class="flex items-center gap-1.5 px-4 py-2 rounded-full text-sm transition-all duration-300 transform hover:scale-105"
                                    :class="story.isSaved ? 'bg-orange-50 text-orange-600' : 'bg-gray-50 text-gray-700 hover:bg-orange-50 hover:text-orange-600'">
                                <svg class="w-4 h-4" :class="story.isSaved ? 'fill-orange-600' : ''" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>
                                <span x-text="story.isSaved ? 'Saved' : 'Save'"></span>
                            </button>

                            <!-- Share -->
                            <div x-data="{ copied: false }" class="relative">
                                <button @click="
                                            navigator.clipboard.writeText(window.location.origin + '/stories/' + story.share_uuid + '/');
                                            copied = true;
                                            setTimeout(() => copied = false, 2000);
                                        "
                                        class="flex items-center gap-1.5 px-4 py-2 rounded-full text-sm bg-gray-50 text-gray-700 hover:bg-green-50 hover:text-green-600 transition-all duration-300 transform hover:scale-105 active:scale-95">
                                    <template x-if="!copied"><svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"></line><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"></line></svg></template>
                                    <template x-if="copied"><svg class="w-4 h-4 text-green-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg></template>
                                    <span x-text="copied ? 'Copied!' : 'Share'"></span>
                                </button>
                            </div>
                        </div>

                        <!-- Comments Section (Selected Story logic) -->
                        <div x-show="activeCommentId === story.id" x-collapse class="mt-6 space-y-4">
                            <!-- Existing Comments -->
                            <template x-for="comment in story.comments" :key="comment.id">
                                <div class="flex gap-3">
                                    <div class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden flex-shrink-0"><template x-if="comment.authorAvatar"><img :src="comment.authorAvatar" class="w-full h-full object-cover"></template></div>
                                    <div class="flex-1 bg-gray-50 rounded-2xl p-4">
                                        <div class="flex items-center gap-2 mb-1"><span class="text-gray-900" x-text="comment.author"></span><span class="text-xs text-gray-500" x-text="comment.timestamp"></span></div>
                                        <p class="text-gray-700 text-sm" x-text="comment.text"></p>
                                    </div>
                                </div>
                            </template>

                            <!-- Add Comment -->
                            <div class="flex gap-3 mt-4">
                                <div class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden flex-shrink-0"><img src="{% if user.profile.profile_picture %}{{ user.profile.profile_picture.url }}{% else %}https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=150&h=150&fit=crop{% endif %}" alt="You" class="w-full h-full object-cover"/></div>
                                <div class="flex-1 flex gap-2">
                                    <input type="text" x-model="newCommentText" @keydown.enter="addComment(story.id)" placeholder="Write a comment..." class="flex-1 px-4 py-3 bg-gray-50 rounded-2xl border border-gray-200 focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                    <button @click="addComment(story.id)" class="p-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-2xl hover:from-blue-600 hover:to-blue-700 transition-all"><svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Modallar (CREATE/EDIT/DELETE/DETAIL) -->

    <!-- CREATE MODAL -->
    <div x-show="showCreateModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="bg-white rounded-3xl w-full max-w-2xl max-h-[90vh] overflow-y-auto" @click.outside="showCreateModal = false">
            <form @submit.prevent="submitStory" id="create-story-form">
                <div class="p-6 border-b sticky top-0 bg-white z-10 flex justify-between items-center">
                    <h2 class="text-xl font-bold">Share Your Story</h2>
                    <button type="button" @click="showCreateModal = false" class="p-2 hover:bg-gray-100 rounded-full"><svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                </div>

                <div class="p-6 space-y-6">
                    {% csrf_token %}
                    <!-- Title -->
                    <div><label class="block text-sm font-bold text-gray-700 mb-2">Story Title *</label><input type="text" name="title" x-model="newStory.title" placeholder="Give your story a catchy title" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-orange-500 outline-none"></div>
                    <!-- Location -->
                    <div><label class="block text-sm font-bold text-gray-700 mb-2">Location *</label><input type="text" name="location" x-model="newStory.location" placeholder="Where did you go?" class="w-full pl-10 pr-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-orange-500 outline-none"></div>
                    <!-- Content -->
                    <div><label class="block text-sm font-bold text-gray-700 mb-2">Your Story *</label><textarea name="content" x-model="newStory.content" rows="8" placeholder="Share your experience, tips, and memorable moments..." class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-orange-500 outline-none resize-none"></textarea></div>
                    <!-- Image Upload -->
                    <div><label class="block text-sm font-bold text-gray-700 mb-2">Add Photos</label><input type="file" name="images" multiple @change="handleFileSelect" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100"/></div>

                    <div class="flex gap-3 pt-4">
                        <button type="button" @click="showCreateModal = false" class="flex-1 py-3 font-bold border border-gray-300 rounded-xl hover:bg-gray-50">Cancel</button>
                        <button type="submit" :disabled="isSubmitting" class="flex-1 py-3 font-bold bg-orange-600 text-white rounded-xl hover:bg-orange-700">Publish</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <!-- EDIT STORY MODAL -->
    <div x-show="showEditModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="bg-white rounded-3xl w-full max-w-2xl max-h-[90vh] overflow-y-auto" @click.outside="showEditModal = false; storyToEdit = null">

            <template x-if="storyToEdit">
                <form @submit.prevent="handleEditStory" id="edit-story-form">
                    <div class="p-6 border-b sticky top-0 bg-white z-10 flex justify-between items-center">
                        <h2 class="text-xl font-bold">Edit Your Story</h2>
                        <button type="button" @click="showEditModal = false; storyToEdit = null" class="p-2 hover:bg-gray-100 rounded-full"><svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                    </div>

                    <div class="p-6 space-y-6">
                        {% csrf_token %}
                        <!-- Title -->
                        <div><label class="block text-sm font-bold text-gray-700 mb-2">Story Title *</label><input type="text" name="title" x-model="storyToEdit.title" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-orange-500 outline-none"></div>
                        <!-- Location -->
                        <div><label class="block text-sm font-bold text-gray-700 mb-2">Location *</label><input type="text" name="location" x-model="storyToEdit.location" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-orange-500 outline-none"></div>
                        <!-- Content -->
                        <div><label class="block text-sm font-bold text-gray-700 mb-2">Your Story *</label><textarea name="content" x-model="storyToEdit.content" rows="8" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-orange-500 outline-none"></textarea></div>

                        <!-- Image Upload -->
                        <div><label class="block text-sm font-bold text-gray-700 mb-2">Add More Photos</label><input type="file" multiple name="new_images" @change="handleEditFileSelect" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100"/></div>

                        <!-- Submit Button -->
                        <div class="flex gap-3 pt-4">
                            <button type="button" @click="showEditModal = false; storyToEdit = null" class="flex-1 py-3 font-bold border border-gray-300 rounded-xl hover:bg-gray-50">Cancel</button>
                            <button type="submit" :disabled="!isChanged" class="flex-1 py-3 font-bold bg-orange-600 text-white rounded-xl hover:bg-orange-700">Save Changes</button>
                        </div>
                    </div>
                </form>
            </template>
        </div>
    </div>

    <!-- DELETE MODAL (Soddalashtirilgan) -->
    <div x-show="showDeleteModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="bg-white rounded-3xl w-full max-w-md p-6" @click.outside="showDeleteModal = false">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"><svg class="w-8 h-8 text-red-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></div>
            <h2 class="text-gray-900 text-center mb-2">Delete Story?</h2>
            <p class="text-gray-600 text-center mb-6">This action cannot be undone. Are you sure?</p>
            <div class="flex gap-3">
                <button type="button" @click="showDeleteModal = false" class="flex-1 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50">Cancel</button>
                <button type="button" @click="handleDeleteStory()" class="flex-1 py-3 bg-red-600 text-white rounded-xl hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>
<!-- SUCCESS NOTIFICATION MODAL -->
<!-- SUCCESS NOTIFICATION MODAL -->
<div x-show="submitSuccess" x-cloak
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-300"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0"
     class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">

    <!-- FINAL KESHNI O'CHIRUVCHI KOD ðŸ‘‡ -->
    <div x-init="
             // 1. Keshdagi holatni majburiy o'chirish (agar reloadda turib qolgan bo'lsa)
             submitSuccess = false;

             // 2. Kuzatuvchi (Watcher) mantiq: Faqatgina Create/Edit dan keyin ishlaydi
             $watch('submitSuccess', (value) => {
                 if (value) {
                     setTimeout(() => {
                         submitSuccess = false;
                         location.reload();
                     }, 5000);
                 }
             })
         "
         class="bg-white rounded-[32px] w-full max-w-md p-10 text-center shadow-2xl border-2 border-green-500/20"
         @click.outside="submitSuccess = false">

        <!-- Icon Box -->
        <div class="w-20 h-20 bg-green-50 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg shadow-green-500/30">
            <svg class="w-10 h-10 text-green-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
        </div>

        <!-- Text -->
        <h2 class="text-3xl font-black text-gray-900 mb-3">Success!</h2>
        <p class="text-lg text-gray-600 mb-8" x-text="successMessage"></p>

        <!-- Button -->
        <button @click="submitSuccess = false; location.reload()"
                class="mt-4 px-8 py-3 bg-green-600 text-white rounded-xl font-bold text-lg hover:bg-green-700 transition-all shadow-md shadow-green-600/30">
            Got it!
        </button>
    </div>
</div>

<!-- DATA & LOGIC -->
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('storiesApp', () => ({
        // STATE
        stories: JSON.parse('{{ stories_json|escapejs }}'),
        currentUserId: {{ current_user_id }},
        activeFilter: 'all',
        showCreateModal: false,
        showEditModal: false,
        showDeleteModal: false,

        // Success Message uchun o'zgaruvchi
        submitSuccess: false,
        successMessage: '',

        storyToEdit: null,
        originalStoryState: null,
        storyToDelete: null,
        activeCommentId: null,
        newCommentText: '',
        newStory: { title: '', location: '', content: '', files: [] },
        isSubmitting: false,

        initApp() {
            this.submitSuccess = false;
            window.onpageshow = (event) => {
                if (event.persisted) this.submitSuccess = false;
            };
        },

        get filteredStories() {
            if (this.activeFilter === 'saved') return this.stories.filter(s => s.isSaved);
            if (this.activeFilter === 'my') return this.stories.filter(s => s.authorId === this.currentUserId);
            return this.stories;
        },

        openComments(id) { this.activeCommentId = (this.activeCommentId === id) ? null : id; },

        openCreateStoryModal() {
            this.newStory = { title: '', location: '', content: '', files: [] };
            this.showCreateModal = true;
        },

        openEditStoryModal(story) {
            this.storyToEdit = { ...story, files: [] };
            this.showEditModal = true;
            this.originalStoryState = JSON.stringify({
                title: story.title,
                location: story.location,
                content: story.content
            });
        },

        get isChanged() {
            if (!this.storyToEdit) return false;
            if (this.storyToEdit.files && this.storyToEdit.files.length > 0) return true;
            const currentState = JSON.stringify({
                title: this.storyToEdit.title,
                location: this.storyToEdit.location,
                content: this.storyToEdit.content
            });
            return currentState !== this.originalStoryState;
        },

        openDeleteStoryModal(id) {
            this.storyToDelete = id;
            this.showDeleteModal = true;
        },

        handleFileSelect(e) { this.newStory.files = e.target.files; },
        handleEditFileSelect(e) { this.storyToEdit.files = e.target.files; },

        // --- API FUNCTIONS ---
        async toggleLike(id) {
            const story = this.stories.find(s => s.id === id);
            story.isLiked = !story.isLiked;
            story.likes += story.isLiked ? 1 : -1;
            await fetch(`/stories/api/like/${id}/`, { method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'} });
        },

        async toggleSave(id) {
            const story = this.stories.find(s => s.id === id);
            story.isSaved = !story.isSaved;
            await fetch(`/stories/api/save/${id}/`, { method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'} });
        },

        async addComment(id) {
            if (!this.newCommentText.trim()) return;
            const text = this.newCommentText;
            this.newCommentText = '';
            const res = await fetch(`/stories/api/comment/${id}/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ text: text })
            });
            if (res.ok) location.reload();
        },

        // --- CREATE STORY (RASM DUBLIKATINI TO'G'IRLASH) ---
        async submitStory() {
            if (!this.newStory.title || !this.newStory.location || !this.newStory.content) return alert('Please fill all required fields');

            this.isSubmitting = true;
            const form = document.getElementById('create-story-form');

            // MUHIM: new FormData(form) o'zi rasmlarni oladi.
            // Qo'shimcha loop SHART EMAS!
            const formData = new FormData(form);

            const res = await fetch('/stories/api/create/', {
                method: 'POST',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                body: formData
            });

            if (res.ok) {
                this.showCreateModal = false;

                // Xabarni "Published" ga o'zgartirdik
                this.successMessage = 'Your story has been published successfully! ðŸš€';

                this.submitSuccess = true;
                setTimeout(() => location.reload(), 1500);
            } else {
                alert('Error creating story.');
            }
            this.isSubmitting = false;
        },

        // --- EDIT STORY ---
        async handleEditStory() {
            if (!this.isChanged) return;

            this.isSubmitting = true;
            const form = document.getElementById('edit-story-form');
            const formData = new FormData(form);

            // Editda ham ortiqcha loop olib tashlandi, FormData o'zi yetarli.

            const res = await fetch(`/stories/api/edit/${this.storyToEdit.id}/`, {
                method: 'POST',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                body: formData
            });

            if (res.ok) {
                this.showEditModal = false;

                // Xabarni "Updated" ga o'zgartirdik
                this.successMessage = 'Your story has been updated successfully! âœ¨';

                this.submitSuccess = true;
                setTimeout(() => location.reload(), 1500);
            } else {
                alert('Error updating story.');
            }
            this.isSubmitting = false;
        },

        async handleDeleteStory() {
            if (!this.storyToDelete) return;
            const res = await fetch(`/stories/api/delete/${this.storyToDelete}/`, {
                method: 'POST',
                headers: {'X-CSRFToken': '{{ csrf_token }}'}
            });
            if (res.ok) {
                this.showDeleteModal = false;
                location.reload();
            }
        }
    }));
});
</script>
{% endblock %}